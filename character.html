<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ด่านที่ 1: เกมจับคู่พยัญชนะ + เข้าสู่ระบบ</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=TH+Sarabun+New:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap (สำหรับแท็บ Login/Register) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- สไตล์หลัก (ถ้ามี) -->
  <link rel="stylesheet" href="css/style.css" />

  <style>
    :root{
      --primary:#2563EB;
      --primary-dark:#1D4ED8;
      --bg:#e0f7fa;
      --surface:#ffffff;
      --border:#e2e8f0;
      --text:#0f172a;
      --muted:#6c757d;
    }
    html,body{height:100%;}
    body{
      font-family:'TH Sarabun New','Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      overflow:hidden; /* คงพฤติกรรมเดิม */
    }

    /* ===== Top bar / เกม ===== */
    #topBar{
      height:74px;
      background:#fff;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; gap:10px;
    }
    #profileSection{display:flex;align-items:center;gap:10px}
    .back-to-lobby-btn img{width:36px;height:36px}
    .profile-pic-game{
      width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--border);cursor:pointer;
    }
    #best-rank-display{font-size:20px;font-weight:700;color:#16a34a}

    #progressSection{flex:1; text-align:center; font-size:20px}
    #statusSection{display:flex; align-items:center; gap:10px}
    #scoreDisplay{
      background:#fff; border:1px solid var(--border); border-radius:999px;
      padding:6px 12px; font-weight:700; display:flex; align-items:center; gap:6px;
    }
    #timerContainer{
      width:200px;height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden;
    }
    #timerFill{ width:0%; height:100%; background:linear-gradient(90deg,#34d399,#10b981) }

    #main-wrapper{height:calc(100vh - 74px); display:flex}
    #gameArea{
      flex:1; padding:16px; overflow:auto;
      background:linear-gradient(180deg,#eff6ff 0%, #e0f2fe 100%);
    }
    .title-container{display:flex;align-items:center;justify-content:space-between; gap:12px; flex-wrap:wrap}
    .main-title{font-size:36px; margin:0}
    .controls button{
      background:var(--primary); color:#fff; border:none; border-radius:12px;
      padding:8px 16px; font-size:20px; font-weight:700; cursor:pointer;
    }
    .controls button:hover{ background:var(--primary-dark) }
    #game{margin-top:16px;}

    /* ===== Sidebar ===== */
    #sidebar-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; z-index:1000;
    }
    #sidebar{
      position:fixed; top:0; right:-340px; width:320px; height:100%;
      background:#fff; box-shadow:-6px 0 18px rgba(0,0,0,.12);
      padding:16px; z-index:1001; transition:right .25s ease;
    }
    #sidebar.open{ right:0 }
    #sidebar-overlay.show{ display:block }
    #sidebarCloseBtn{
      position:absolute; top:8px; right:12px; font-size:30px; cursor:pointer;
    }
    #sidebarProfileImg{width:96px; height:96px; border-radius:50%; object-fit:cover; display:block; margin:12px auto}
    #logoutBtn{
      background:#ef4444; color:#fff; padding:10px 12px; border:none; border-radius:10px;
      font-size:20px; font-weight:700; cursor:pointer
    }
    #logoutBtn:hover{ filter:brightness(.95) }

    /* ===== Popup ===== */
    #popup{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; }
    #popupBox{
      width:min(560px,92vw); background:#fff; border-radius:20px; padding:18px;
      border:1px solid var(--border); box-shadow:0 16px 46px rgba(0,0,0,.12)
    }
    .popup-controls{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }

    /* ===== หน้า Lesson ===== */
    #lesson-page{
      position:fixed; inset:24px; background:#fff; border-radius:18px; border:1px solid var(--border);
      padding:16px; z-index:1050; display:none; overflow:auto
    }
    #close-lesson-btn{ position:absolute; right:14px; top:12px; background:#e11d48; color:#fff; border:none; border-radius:999px; padding:4px 12px; font-size:18px }

    /* ===== แคนวาสคอนเฟตติ ===== */
    #confetti-canvas{ position:fixed; inset:0; z-index:1001; pointer-events:none; }

    /* ===== กล่อง Login/Register (overlay ทั้งหน้า) ===== */
    .auth-overlay{
      position:fixed; inset:0; background:linear-gradient(180deg, rgba(37,99,235,.18), rgba(5,150,105,.18));
      display:flex; align-items:center; justify-content:center; z-index:1200;
    }
    .login-form{
      width:min(420px,92vw); background:#fff; padding:2.2rem; border-radius:14px;
      box-shadow:0 0 0 1px rgba(0,0,0,.05), 0 16px 38px rgba(0,0,0,.12);
    }
    .form-control-lg{ font-size:1rem; padding:.9rem; height:3.125rem; border:1px solid #dadce0 }
    .action-btn{ border:none; width:100%; padding:.75rem; border-radius:8px; font-weight:700; font-size:1.05rem }
    .google-btn{
      background:#fff; color:#333; border:1px solid #dadce0; display:flex; align-items:center; justify-content:center; gap:.6rem
    }
    .google-btn:hover{ background:#f8f9fa }
    .google-icon{ width:1.25rem; height:1.25rem }
    .nav-tabs .nav-link{ color:#6c757d; font-weight:700; font-size:1.05rem }
    .nav-tabs .nav-link.active{ color:var(--primary); border-color:var(--primary) var(--primary) #fff }

    .auth-msg{ margin-top:10px; padding:10px; border-radius:10px; display:none; }
    .auth-msg.error{ background:#fee2e2; color:#991b1b; display:block; }
    .auth-msg.success{ background:#dcfce7; color:#166534; display:block; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>

  <!-- ======== AUTH (แสดงก่อนถ้ายังไม่ล็อกอิน) — ซ้อนอยู่เสมอแต่ซ่อนเมื่อสำเร็จ ======== -->
  <div id="authOverlay" class="auth-overlay">
    <div class="login-form" role="dialog" aria-label="กล่องเข้าสู่ระบบ">
      <ul class="nav nav-tabs nav-fill mb-4" id="authTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab">เข้าสู่ระบบ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane" type="button" role="tab">ลงทะเบียน</button>
        </li>
      </ul>

      <div id="authMsg" class="auth-msg"></div>

      <div class="tab-content" id="authTabContent">
        <!-- Login -->
        <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
          <form id="loginForm">
            <div class="mb-3">
              <input type="email" class="form-control form-control-lg" id="login-email" placeholder="อีเมล" required />
            </div>
            <div class="mb-4">
              <input type="password" class="form-control form-control-lg" id="login-password" placeholder="รหัสผ่าน" required />
            </div>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary action-btn">เข้าสู่ระบบ</button>
            </div>
            <div class="text-center my-3 text-muted">&mdash; หรือ &mdash;</div>
            <button type="button" id="googleBtn" class="btn google-btn action-btn">
              <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="" class="google-icon" />
              เข้าสู่ระบบด้วย Google
            </button>
          </form>
        </div>

        <!-- Register -->
        <div class="tab-pane fade" id="register-pane" role="tabpanel">
          <form id="registerForm">
            <div class="mb-3"><input type="text" class="form-control form-control-lg" id="register-name" placeholder="ชื่อ" required></div>
            <div class="mb-3"><input type="email" class="form-control form-control-lg" id="register-email" placeholder="อีเมล" required></div>
            <div class="mb-3"><input type="password" class="form-control form-control-lg" id="register-password" placeholder="รหัสผ่าน" required></div>
            <div class="mb-4"><input type="password" class="form-control form-control-lg" id="register-confirm-password" placeholder="ยืนยันรหัสผ่าน" required></div>
            <div class="d-grid"><button type="submit" class="btn btn-primary action-btn">สร้างบัญชี</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== TOP BAR เกม ======== -->
  <div id="topBar" class="hidden" aria-label="แถบสถานะเกม">
    <div id="profileSection">
      <a href="index.html" class="back-to-lobby-btn" title="กลับไปหน้าล็อบบี้">
        <img src="images/icon/back.png" alt="ย้อนกลับ" />
      </a>
      <img id="profilePic-game" src="" alt="โปรไฟล์" class="profile-pic-game" title="เปิดโปรไฟล์/ออกจากระบบ" />
      <div id="best-rank-display"></div>
    </div>

    <div id="progressSection"></div>

    <div id="statusSection">
      <div id="roundCoinContainer"></div>
      <div id="scoreDisplay"><span class="money-bag-icon">💰</span><span id="scoreValue">0</span></div>
      <div id="livesDisplay"></div>
      <div id="timerContainer"><div id="timerFill"></div></div>
    </div>
  </div>

  <!-- ======== SIDEBAR โปรไฟล์ ======== -->
  <div id="sidebar-overlay"></div>
  <aside id="sidebar" aria-label="แถบด้านข้างโปรไฟล์">
    <span id="sidebarCloseBtn" aria-label="ปิดเมนู">&times;</span>
    <img id="sidebarProfileImg" src="" alt="รูปโปรไฟล์" />
    <h2 id="sidebarUserName"></h2>
    <p id="sidebarUserEmail"></p>
    <button id="logoutBtn">ออกจากระบบ</button>
  </aside>

  <!-- ======== พื้นที่เล่นเกม ======== -->
  <div id="main-wrapper" class="hidden">
    <div id="gameArea">
      <div class="title-container">
        <h1 class="main-title">ด่านที่ 1: จับคู่พยัญชนะ</h1>
        <div class="controls">
          <button id="lessonBtn" type="button">บทเรียน</button>
          <button id="startBtn" type="button">เริ่มเกม</button>
          <button id="restartBtn" type="button" style="display:none;">เริ่มใหม่</button>
        </div>
      </div>
      <div id="game" aria-live="polite"></div>
    </div>
  </div>

  <!-- ======== POPUP ======== -->
  <div id="popup" role="dialog" aria-modal="true">
    <div id="popupBox">
      <div id="popupText"></div>
      <div id="popupControls" class="popup-controls"></div>
    </div>
  </div>

  <!-- ======== หน้า LESSON ======== -->
  <section id="lesson-page" aria-label="บทเรียนพยัญชนะไทย">
    <button id="close-lesson-btn" type="button">&times; ปิด</button>
    <h2>บทเรียนพยัญชนะไทย</h2>
    <div id="lesson-grid"></div>
  </section>

  <!-- ======== คอนเฟตติ ======== -->
  <canvas id="confetti-canvas"></canvas>

  <!-- ======== Libraries ======== -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <!-- ======== สคริปต์เกม (ไฟล์ของคุณ) ======== -->
  <script src="js/character.js"></script>

  <!-- ======== การเชื่อม Login + เกม ในหน้าเดียว ======== -->
  <script>
    /* ========= 1) กำหนด Firebase ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyCmKRzrsXDhHtbmhG56jM-0OYqp3YvXc48",
      authDomain: "playtolearn-e3356.firebaseapp.com",
      projectId: "playtolearn-e3356",
      storageBucket: "playtolearn-e3356.firebasestorage.app",
      messagingSenderId: "233629701249",
      appId: "1:233629701249:web:5ee775473bc00be1566980",
      measurementId: "G-SXMFQT0TLG"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ✅ คงสถานะผู้ใช้ข้ามการเปิดปิดแท็บ (อยู่หน้าเดิมต่อ)
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    /* ========= 2) อ้างอิงองค์ประกอบหน้าจอ ========== */
    const authOverlay = document.getElementById('authOverlay');
    const authMsg     = document.getElementById('authMsg');

    const topBar = document.getElementById('topBar');
    const mainWrapper = document.getElementById('main-wrapper');

    const profilePicGame = document.getElementById('profilePic-game');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
    const sidebarProfileImg = document.getElementById('sidebarProfileImg');
    const sidebarUserName = document.getElementById('sidebarUserName');
    const sidebarUserEmail = document.getElementById('sidebarUserEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const googleBtn = document.getElementById('googleBtn');

    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const lessonBtn = document.getElementById('lessonBtn');

    const lessonPage = document.getElementById('lesson-page');
    const closeLessonBtn = document.getElementById('close-lesson-btn');

    /* ========= Helpers ========= */
    function showOverlay(){ authOverlay.classList.remove('hidden'); }
    function hideOverlay(){ authOverlay.classList.add('hidden'); }
    function setMsg(type, text){
      authMsg.className = 'auth-msg ' + (type || '');
      authMsg.textContent = text || '';
      authMsg.style.display = text ? 'block' : 'none';
    }
    function openSidebar(){ sidebar.classList.add('open'); sidebarOverlay.classList.add('show'); }
    function closeSidebar(){ sidebar.classList.remove('open'); sidebarOverlay.classList.remove('show'); }

    sidebarCloseBtn.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    profilePicGame.addEventListener('click', openSidebar);

    // แปล error code เป็นไทยสั้น ๆ
    function tAuthError(code){
      const map = {
        'auth/invalid-email':'อีเมลไม่ถูกต้อง',
        'auth/user-not-found':'ไม่พบบัญชีผู้ใช้',
        'auth/wrong-password':'รหัสผ่านไม่ถูกต้อง',
        'auth/email-already-in-use':'อีเมลนี้ถูกใช้แล้ว',
        'auth/weak-password':'รหัสผ่านสั้นเกินไป',
        'auth/popup-blocked':'เบราว์เซอร์บล็อกป๊อปอัป โปรดอนุญาต',
        'auth/popup-closed-by-user':'ปิดหน้าต่างล็อกอินก่อนเสร็จ',
        'auth/operation-not-allowed':'ยังไม่เปิดใช้ผู้ให้บริการในคอนโซล',
        'auth/unauthorized-domain':'โดเมนยังไม่ได้อนุญาตใน Firebase Console'
      };
      return map[code] || ('เกิดข้อผิดพลาด: ' + code);
    }

    /* ========= 3) ฟังก์ชัน Login/Logout/Register ========== */
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg('', '');
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        setMsg('success', 'เข้าสู่ระบบสำเร็จ');
      }catch(err){
        setMsg('error', tAuthError(err.code));
      }
    });

    registerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg('', '');
      const name = document.getElementById('register-name').value.trim();
      const email= document.getElementById('register-email').value.trim();
      const pass = document.getElementById('register-password').value;
      const pass2= document.getElementById('register-confirm-password').value;
      if(pass !== pass2){ setMsg('error', 'รหัสผ่านไม่ตรงกัน'); return; }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: name });
        setMsg('success', 'ลงทะเบียนสำเร็จ! กำลังเข้าสู่ระบบ…');
        // เข้าสู่ระบบต่อเนื่องในหน้านี้
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(err){
        setMsg('error', tAuthError(err.code));
      }
    });

    googleBtn.addEventListener('click', async ()=>{
      setMsg('', '');
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider); // ไม่ออกนอกหน้า
      }catch(err){
        if (err && err.code === 'auth/popup-blocked') {
          // Fallback: redirect (ยังอยู่ origin เดิม เมื่อกลับมาจะ trigger onAuthStateChanged)
          try{
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithRedirect(provider);
          }catch(e2){
            setMsg('error', tAuthError(e2.code));
          }
        } else {
          setMsg('error', tAuthError(err.code));
        }
      }
    });

    logoutBtn.addEventListener('click', async ()=>{
      await auth.signOut();
      closeSidebar();
      // กลับมาแสดง overlay ในหน้านี้ต่อ
      showOverlay();
      setMsg('', '');
    });

    /* ========= 4) เฝ้าดูสถานะผู้ใช้: อยู่หน้าเดิม & ซ่อน/โชว์ overlay ========= */
    auth.onAuthStateChanged(user=>{
      if(user){
        hideOverlay();                // ซ่อนฟอร์ม แต่ยังซ้อนอยู่ใน DOM
        topBar.classList.remove('hidden');
        mainWrapper.classList.remove('hidden');

        // เติมข้อมูลโปรไฟล์
        const photo = user.photoURL || 'images/icon/user.png';
        profilePicGame.src = photo;
        sidebarProfileImg.src = photo;
        sidebarUserName.textContent = user.displayName || 'ผู้ใช้ใหม่';
        sidebarUserEmail.textContent = user.email || '';
      }else{
        showOverlay();                // โชว์ฟอร์มทับหน้าเดิม
        topBar.classList.add('hidden');
        mainWrapper.classList.add('hidden');
      }
    });

    /* ========= 5) ปุ่มควบคุมเกม (เรียกจาก character.js) ========= */
    lessonBtn.addEventListener('click', ()=>{ lessonPage.style.display = 'block'; });
    closeLessonBtn.addEventListener('click', ()=>{ lessonPage.style.display = 'none'; });

    startBtn.addEventListener('click', ()=>{
      if(typeof startGame === 'function'){ startGame(); }
      else setMsg('error','ยังไม่พบฟังก์ชัน startGame() ใน js/character.js');
    });

    restartBtn.addEventListener('click', ()=>{
      if(typeof restartGame === 'function'){ restartGame(); }
      else setMsg('error','ยังไม่พบฟังก์ชัน restartGame() ใน js/character.js');
    });
  </script>
</body>
</html>
