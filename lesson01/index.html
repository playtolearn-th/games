<!DOCTYPE html>
<html lang="th">

  <head>
    <meta charset="UTF-8" />
    <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà ‡πë ‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=TH+Sarabun+New:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.min.css">
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: #f0f0f0;
        font-family: 'TH Sarabun New', sans-serif;
        height: 100%;
        overflow: hidden;
      }

      h1 {
        margin: .5rem;
        text-align: center;
        font-size: clamp(1.5rem, 3vw, 2.5rem);
      }

      #preloader {
        position: fixed;
        inset: 0;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-size: 2rem;
      }

      #container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        box-sizing: border-box;
      }

      #flipbook {
        position: relative;
        width: 90vw;
        height: 80vh;
        max-width: 1000px;
        max-height: 700px;
        background: #e0e0e0;
      }

      .page {
        width: 100%;
        height: 100%;
        background: #fff;
        border: 1px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        margin: 0;
        position: relative;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* ‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß */
      .image-page:not(.spread-image)>img,
      .image-page:not(.spread-image)>video {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .page.spread-image {
        overflow: hidden;
      }

      .page.spread-image img,
      .page.spread-image video {
        max-width: none;
        width: 200%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        transform: none;
      }

      .page.spread-image video {
        pointer-events: none;
      }

      .page.spread-left img,
      .page.spread-left video {
        left: 0;
      }

      .page.spread-right img,
      .page.spread-right video {
        left: -100%;
      }

      /* ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
      .karaoke-wrap {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
      }

      .karaoke-lines {
        display: flex;
        flex-direction: column;
        gap: .8rem;
        line-height: 1.2;
        max-width: 100%;
      }

      .karaoke-line {
        display: flex;
        align-items: center;
        gap: .6rem;
        justify-content: center;
        cursor: pointer;
      }

      .karaoke-text {
        font-size: clamp(2rem, 4.8vw, 4.2rem);
        white-space: nowrap;
      }

      .karaoke-text.bold {
        font-weight: 700;
      }

      .karaoke-word {
        padding: 0 .25rem;
        border-bottom: 3px solid transparent;
        transition: color .15s ease, border-color .15s ease;
      }

      .karaoke-line::before {
        content: 'üîä';
        font-size: clamp(1rem, 2.5vw, 1.2rem);
        opacity: 0.3;
        transition: opacity 0.2s ease;
      }

      .karaoke-line:hover::before {
        opacity: 1;
      }

      .karaoke-word.active {
        color: #d94100;
        border-color: #d94100;
      }

      .karaoke-word.done {
        color: #6b7280;
        border-color: transparent;
      }

      /* ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
      .img-title {
        position: absolute;
        left: 50%;
        top: 10%;
        transform: translateX(-50%);
        padding: .25rem .8rem;
        border-radius: .75rem;
        background: rgba(255, 255, 255, .6);
        backdrop-filter: blur(2px);
        white-space: nowrap;
      }

      .img-title .karaoke-word {
        font-size: clamp(2.8rem, 6.5vw, 5.5rem);
      }

      .side-by-side {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: min(3vw, 24px);
        padding: min(3vw, 24px);
      }

      .side-by-side img {
        max-height: 70%;
        max-width: 45%;
        object-fit: contain;
      }

      .img-overlay-bottom {
        position: absolute;
        left: 50%;
        bottom: 10%;
        transform: translateX(-50%);
        padding: .25rem .8rem;
        border-radius: .75rem;
        background: rgba(255, 255, 255, .6);
        backdrop-filter: blur(2px);
        white-space: nowrap;
        max-width: 92%;
        overflow: hidden;
      }

      .img-overlay-bottom .karaoke-word {
        font-size: var(--fit-size, clamp(2rem, 4.8vw, 4.2rem));
      }

      .text-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
      }

      .text-container .karaoke-word {
        font-size: var(--fit-size, clamp(5rem, 18vw, 12rem));
        line-height: 1.1;
        display: block;
        white-space: nowrap;
      }

      .hint {
        font-size: clamp(.9rem, 2.2vw, 1.1rem);
        color: #666;
        margin-top: .2rem;
      }

      /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
      .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 56px;
        height: 56px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 20;
      }

      .nav-btn img {
        width: 100%;
        height: 100%;
      }

      #prevBtn {
        left: -66px;
      }

      #nextBtn {
        right: -66px;
      }

      .corner {
        position: absolute;
        width: 68px;
        height: 68px;
        z-index: 15;
        cursor: pointer;
      }

      .corner.tl {
        left: 0;
        top: 0;
      }

      .corner.tr {
        right: 0;
        top: 0;
      }

      /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
      .letter-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: min(2.5vh, 16px);
        padding: min(3vw, 24px);
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .letter-stack img {
        max-height: 55%;
        max-width: 80%;
        object-fit: contain;
        pointer-events: none;
      }

      .letter-stack .big-char {
        font-size: clamp(5rem, 18vw, 12rem);
        line-height: .9;
      }
    </style>
  </head>

  <body>
    <div id="preloader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <h1>üìñ ‡∏ö‡∏ó‡∏ó‡∏µ‡πà ‡πë ‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß</h1>

    <div id="container">
      <div id="flipbook">
        <button id="prevBtn" class="nav-btn" aria-label="‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
          <img src="../images/icon/back.png" alt="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö">
        </button>
        <button id="nextBtn" class="nav-btn" aria-label="‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
          <img src="../images/icon/next.png" alt="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
        </button>
        <div class="corner tl" role="button" tabindex="0" aria-label="‡∏û‡∏•‡∏¥‡∏Å‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"></div>
        <div class="corner tr" role="button" tabindex="0" aria-label="‡∏û‡∏•‡∏¥‡∏Å‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>
    <script>
      // ---------- GLOBAL VARIABLES & AUDIO SETUP ----------
      const flipbook = document.getElementById('flipbook');
      const sharedAudio = new Audio();
      let currentHighlight = null;
      let pageFlip;

      // ---------- HELPER FUNCTIONS ----------
      const toURL = (p) => p ? encodeURI(p.trim()) : '';

      function playSound(path) {
        if (path) {
          sharedAudio.src = path;
          return sharedAudio.play();
        }
        return Promise.reject('No path provided');
      }

      function ensureDuration() {
        return new Promise(res => {
          if (!isNaN(sharedAudio.duration) && sharedAudio.duration > 0) return res(sharedAudio.duration);
          sharedAudio.addEventListener('loadedmetadata', () => res(sharedAudio.duration || 0), { once: true });
        });
      }

      // ---------- CONTENT DATA ----------
      const chars = [
        { word: '‡∏Ç‡∏≤', image: 'images/‡∏Ç‡∏≤.png', sound: 'sounds/‡∏Ç‡∏≤.mp3' },
        { word: '‡∏á‡∏≤', image: 'images/‡∏á‡∏≤.png', sound: 'sounds/‡∏á‡∏≤.mp3' },
        { word: '‡∏ï‡∏≤', image: 'images/‡∏ï‡∏≤.png', sound: 'sounds/‡∏ï‡∏≤.mp3' },
        { word: '‡∏´‡∏π', image: 'images/‡∏´‡∏π.png', sound: 'sounds/‡∏´‡∏π.mp3' },
        { word: '‡∏°‡∏≤', image: 'images/‡∏°‡∏≤.png', sound: 'sounds/‡∏°‡∏≤.mp3' },
        { word: '‡∏°‡∏µ', image: 'images/‡∏°‡∏µ.png', sound: 'sounds/‡∏°‡∏µ.mp3' },
        { word: '‡∏î‡∏π', image: 'images/‡∏î‡∏π.png', sound: 'sounds/‡∏î‡∏π.mp3' },
        { word: '‡πÑ‡∏°‡πà', image: 'images/‡πÑ‡∏°‡πà.png', sound: 'sounds/‡πÑ‡∏°‡πà.mp3' },
        { word: '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å', image: 'images/‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å.png', sound: 'sounds/‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å.mp3' },
        { word: '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß', image: 'images/‡πÉ‡∏ö‡∏ö‡∏±‡∏ß.png', sound: 'sounds/‡πÉ‡∏ö‡∏ö‡∏±‡∏ß.mp3' },
      ];
      const titleText = '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß';
      const titleAudio = 'sounds/‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß.mp3';
      const leftImageForSpread = 'images/‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏≤‡∏ó‡∏µ01.png';
      const karaokeLinesRight = [
        { text: '‡∏°‡∏≤ ‡∏°‡∏≤ ‡∏°‡∏≤‡∏î‡∏π', audio: 'sounds/‡∏°‡∏≤ ‡∏°‡∏≤ ‡∏°‡∏≤‡∏î‡∏π.mp3' },
        { text: '‡∏°‡∏≤‡∏î‡∏π ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß', audio: 'sounds/‡∏°‡∏≤‡∏î‡∏π ‡πÉ‡∏ö‡∏ö‡∏±‡∏ß.mp3' },
        { text: '‡∏°‡∏≤‡∏î‡∏π ‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å', audio: 'sounds/‡∏°‡∏≤‡∏î‡∏π ‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å.mp3' },
      ];
      const bogokTexts = ['‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏Ç‡∏≤', '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏á‡∏ß‡∏á', '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏ï‡∏≤', '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏´‡∏≤‡∏á', '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏´‡∏π', '‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å ‡∏°‡∏µ ‡∏á‡∏≤'];
      const bogokPages = bogokTexts.map(text => ({ leftImg: 'images/‡πÉ‡∏ö‡πÇ‡∏ö‡∏Å.png', rightImg: `images/${text}.png`, text, audio: `sounds/${text}.mp3` }));
      const buaTexts = ['‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡∏°‡∏µ ‡∏Ç‡∏≤', '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡∏°‡∏µ ‡∏á‡∏ß‡∏á', '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡∏°‡∏µ ‡∏ï‡∏≤', '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡∏°‡∏µ ‡∏´‡∏≤‡∏á', '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡∏°‡∏µ ‡∏´‡∏π', '‡πÉ‡∏ö‡∏ö‡∏±‡∏ß ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏á‡∏≤'];
      const buaPages = buaTexts.map(text => ({ leftImg: 'images/‡πÉ‡∏ö‡∏ö‡∏±‡∏ß.png', rightImg: `images/${text}.png`, text, audio: `sounds/${text}.mp3` }));
      const mixedOneWordPages = [];
      const maxLen = Math.max(bogokPages.length, buaPages.length);
      for (let i = 0; i < maxLen; i++) {
        if (bogokPages[i]) mixedOneWordPages.push(bogokPages[i]);
        if (buaPages[i]) mixedOneWordPages.push(buaPages[i]);
      }
      const extraHead = { text: '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', audio: 'sounds/‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ.mp3' };
      const subHead = { text: '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞', audio: 'sounds/‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞.mp3' };
      const letterPages = [
        { ch: '‡∏Å', img: '../images/character/‡∏Å.png', audio: 'sounds/‡∏Å‡∏≠‡πÑ‡∏Å‡πà ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏Å‡∏≠.mp3' },
        { ch: '‡∏à', img: '../images/character/‡∏à.png', audio: 'sounds/‡∏à‡∏≠‡∏à‡∏≤‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏à‡∏≠.mp3' },
        { ch: '‡∏î', img: '../images/character/‡∏î.png', audio: 'sounds/‡∏î‡∏≠‡πÄ‡∏î‡πá‡∏Å ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏î‡∏≠.mp3' },
        { ch: '‡∏ï', img: '../images/character/‡∏ï.png', audio: 'sounds/‡∏ï‡∏≠‡πÄ‡∏ï‡πà‡∏≤ ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏ï‡∏≠.mp3' },
        { ch: '‡∏ö', img: '../images/character/‡∏ö.png', audio: 'sounds/‡∏ö‡∏≠‡πÉ‡∏ö‡πÑ‡∏°‡πâ ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏ö‡∏≠.mp3' },
        { ch: '‡∏õ', img: '../images/character/‡∏õ.png', audio: 'sounds/‡∏õ‡∏≠‡∏õ‡∏•‡∏≤ ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏õ‡∏≠.mp3' },
        { ch: '‡∏≠', img: '../images/character/‡∏≠.png', audio: 'sounds/‡∏≠‡∏≠‡∏≠‡πà‡∏≤‡∏á ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏≠‡∏≠.mp3' },
        { ch: '‡∏Ç', img: '../images/character/‡∏Ç.png', audio: 'sounds/‡∏Ç‡∏≠‡πÑ‡∏Ç‡πà ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏Ç‡∏≠.mp3' },
        { ch: '‡∏´', img: '../images/character/‡∏´.png', audio: 'sounds/‡∏´‡∏≠‡∏´‡∏µ‡∏ö ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏´‡∏≠.mp3' },
        { ch: '‡∏á', img: '../images/character/‡∏á.png', audio: 'sounds/‡∏á‡∏≠‡∏á‡∏π ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏á‡∏≠.mp3' },
        { ch: '‡∏°', img: '../images/character/‡∏°.png', audio: 'sounds/‡∏°‡∏≠‡∏°‡πâ‡∏≤ ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ ‡∏°‡∏≠.mp3' },
      ];

      // ---------- DYNAMIC PAGE CREATION FUNCTIONS ----------
      const fittedLines = [];
      function fitLineToWidth(line, page, { max = 76, min = 28, step = 2 } = {}) {
        let size = max;
        const maxWidth = page.clientWidth * 0.92;
        if (!line.hasChildNodes()) return;
        for (let guard = 0; guard < 40; guard++) {
          line.style.setProperty('--fit-size', size + 'px');
          if (line.scrollWidth <= maxWidth || size <= min) break;
          size -= step;
        }
      }

      async function setupAudioInteraction(clickableElement, soundPath, highlightContainer) {
        clickableElement.addEventListener('click', async () => {
          if (!soundPath) return;

          if (currentHighlight?.clear) currentHighlight.clear();

          const spans = Array.from(highlightContainer.querySelectorAll('.karaoke-word'));
          let timer = null;
          const clearHL = () => { clearTimeout(timer); spans.forEach(s => s.classList.remove('active', 'done')); };
          currentHighlight = { clear: clearHL };

          if (!sharedAudio.paused) { sharedAudio.pause(); sharedAudio.currentTime = 0; }

          try {
            await playSound(soundPath);
            const dur = await ensureDuration();
            const each = (dur > 0 ? dur / spans.length : 0.5);
            let idx = 0;
            const advance = () => {
              if (idx >= spans.length) { clearHL(); return; }
              spans.forEach((s, i) => { s.classList.toggle('active', i === idx); s.classList.toggle('done', i < idx); });
              idx++;
              timer = setTimeout(advance, Math.max(60, Math.round(each * 1000)));
            };
            advance();
            sharedAudio.addEventListener('ended', clearHL, { once: true });
          } catch (err) {
            console.warn('‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:', err);
            clearHL();
          }
        });
      }

      function createPage(content, opts = {}) {
        const { isImage = false, altText = '', soundPath = null } = opts;
        const page = document.createElement('div');
        page.className = 'page';
        if (isImage) {
          page.classList.add('image-page');
          const img = new Image();
          img.src = content;
          img.alt = altText || '‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö';
          page.appendChild(img);
        } else {
          const wrap = document.createElement('div');
          wrap.className = 'text-container';
          const textElement = document.createElement('span');
          textElement.className = 'karaoke-word';
          textElement.textContent = content;
          wrap.appendChild(textElement);
          const hint = document.createElement('div');
          hint.className = 'hint';
          hint.textContent = '‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
          wrap.appendChild(hint);
          page.appendChild(wrap);

          setupAudioInteraction(wrap, soundPath, wrap);

          fittedLines.push({
            line: textElement,
            page,
            opts: { max: 180, min: 40, step: 4 }
          });
        }
        return page;
      }

      function createCoverVideoSpread(src) {
        const make = (sideClass) => {
          const page = document.createElement('div');
          page.className = 'page image-page spread-image ' + sideClass;
          const vid = document.createElement('video');
          vid.src = src;
          vid.autoplay = true;
          vid.muted = true;
          vid.loop = true;
          vid.playsInline = true;
          page.appendChild(vid);
          return page;
        };
        return [make('spread-left'), make('spread-right')];
      }

      // ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
      function createSingleVideoPage(src) {
        const page = document.createElement('div');
        page.className = 'page image-page';
        const vid = document.createElement('video');
        vid.src = src;
        vid.autoplay = true;   // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        vid.muted = true;      // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ autoplay ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ
        vid.loop = true;       // ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏ô
        vid.playsInline = true;
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏î‡∏±‡∏Å event ‡∏ó‡∏µ‡πà flipbook (capture) ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà controls
        page.appendChild(vid);
        return page;
      }

      function createImageWithKaraokeTitle(imagePath, title, audioPath, alt = '‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö') {
        const page = document.createElement('div');
        page.className = 'page image-page';
        const img = new Image();
        img.src = imagePath;
        img.alt = alt;
        page.appendChild(img);
        const titleBox = document.createElement('div');
        titleBox.className = 'img-title karaoke-line';
        title.trim().split(/\s+/).forEach(w => {
          const s = document.createElement('span');
          s.className = 'karaoke-word';
          s.textContent = w;
          titleBox.appendChild(s);
        });
        page.appendChild(titleBox);
        setupAudioInteraction(titleBox, audioPath, titleBox);
        return page;
      }

      function createOneWordPage({ leftImg, rightImg, text, audio }) {
        const page = document.createElement('div');
        page.className = 'page';
        const wrap = document.createElement('div');
        wrap.className = 'side-by-side';
        const imgLeft = new Image();
        imgLeft.src = leftImg;
        imgLeft.alt = text.split(' ')[0];
        const imgRight = new Image();
        imgRight.src = encodeURI(rightImg);
        imgRight.alt = text;
        wrap.append(imgLeft, imgRight);
        page.appendChild(wrap);
        const line = document.createElement('div');
        line.className = 'img-overlay-bottom karaoke-line';
        text.trim().split(/\s+/).forEach(w => {
          const s = document.createElement('span');
          s.className = 'karaoke-word';
          s.textContent = w;
          line.appendChild(s);
        });
        page.appendChild(line);
        setupAudioInteraction(line, audio, line);
        fittedLines.push({ line, page });
        return page;
      }

      function createTwoLineHeadPage(head, sub) {
        const page = document.createElement('div');
        page.className = 'page';
        const wrap = document.createElement('div');
        wrap.className = 'karaoke-wrap';
        const makeRow = (text, audio, isBold) => {
          const row = document.createElement('div');
          row.className = 'karaoke-line';
          const box = document.createElement('div');
          box.className = 'karaoke-text' + (isBold ? ' bold' : '');
          text.trim().split(/\s+/).forEach(w => {
            const s = document.createElement('span');
            s.className = 'karaoke-word';
            s.textContent = w;
            box.appendChild(s);
          });
          row.appendChild(box);
          setupAudioInteraction(row, audio, row);
          return row;
        };
        wrap.append(makeRow(head.text, head.audio, true), makeRow(sub.text, sub.audio, false));
        const cap = document.createElement('div');
        cap.className = 'hint';
        cap.textContent = '‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
        wrap.appendChild(cap);
        page.appendChild(wrap);
        return page;
      }

      function createLetterPage({ ch, img, audio }) {
        const page = document.createElement('div');
        page.className = 'page';
        const stack = document.createElement('div');
        stack.className = 'letter-stack';
        const picture = new Image();
        picture.src = toURL(img);
        picture.alt = ch;
        const big = document.createElement('div');
        big.className = 'karaoke-word big-char';
        big.textContent = ch;
        stack.append(picture, big);
        page.appendChild(stack);
        setupAudioInteraction(stack, audio, stack);
        return page;
      }

      function createKaraokeThreeLinesPage(items) {
        const page = document.createElement('div');
        page.className = 'page';
        const wrap = document.createElement('div');
        wrap.className = 'karaoke-wrap';
        const linesBox = document.createElement('div');
        linesBox.className = 'karaoke-lines';
        items.forEach(({ text, audio }) => {
          const lineRow = document.createElement('div');
          lineRow.className = 'karaoke-line';
          const textBox = document.createElement('div');
          textBox.className = 'karaoke-text';
          text.trim().split(/\s+/).forEach(w => {
            const s = document.createElement('span');
            s.className = 'karaoke-word';
            s.textContent = w;
            textBox.appendChild(s);
          });
          lineRow.appendChild(textBox);
          linesBox.appendChild(lineRow);
          setupAudioInteraction(lineRow, audio, lineRow);
        });
        const cap = document.createElement('div');
        cap.className = 'hint';
        cap.textContent = '‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
        wrap.append(linesBox, cap);
        page.appendChild(wrap);
        return page;
      }

      // ---------- BUILD BOOK PAGES ----------
      const [coverL, coverR] = createCoverVideoSpread('clip/cove.mp4');
      flipbook.append(coverL, coverR);

      chars.forEach(ch =>
        flipbook.append(
          createPage(ch.image, { isImage: true, altText: ch.word }),
          createPage(ch.word, { soundPath: ch.sound })
        )
      );

      flipbook.append(
        createImageWithKaraokeTitle(leftImageForSpread, titleText, titleAudio),
        createKaraokeThreeLinesPage(karaokeLinesRight)
      );

      mixedOneWordPages.forEach(item => flipbook.append(createOneWordPage(item)));

      flipbook.append(createTwoLineHeadPage(extraHead, subHead));

      letterPages.forEach(lp => flipbook.append(createLetterPage(lp)));

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢" ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ cove.mp4 (‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)
      flipbook.append(createSingleVideoPage('clip/cove.mp4'));

      // ---------- INITIALIZATION & EVENT LISTENERS ----------
      window.addEventListener('DOMContentLoaded', () => {
        pageFlip = new St.PageFlip(flipbook, {
          width: flipbook.clientWidth / 2,
          height: flipbook.clientHeight,
          size: 'fixed',
          showCover: false,
          flippingTime: 800,
        });
        pageFlip.loadFromHTML(document.querySelectorAll('.page'));

        const refitAllLines = () => {
          document.fonts?.ready.then(() => {
            fittedLines.forEach(({ line, page, opts }) => fitLineToWidth(line, page, opts));
          });
        };
        window.addEventListener('resize', refitAllLines);
        refitAllLines();

        document.getElementById('prevBtn').addEventListener('click', () => pageFlip.flipPrev());
        document.getElementById('nextBtn').addEventListener('click', () => pageFlip.flipNext());
        flipbook.querySelector('.corner.tl').addEventListener('click', () => pageFlip.flipPrev());
        flipbook.querySelector('.corner.tr').addEventListener('click', () => pageFlip.flipNext());

        pageFlip.on('flip', () => {
          document.querySelectorAll('.page').forEach(p => {
            if (p.__finalKaraoke__) p.__finalKaraoke__.pause();
          });
        });

        const blockFlipHandler = (e) => {
          if (!e.target.closest('.corner, .nav-btn')) {
            e.stopPropagation();
          }
        };
        ['pointerdown', 'mousedown', 'touchstart'].forEach(evt => {
          flipbook.addEventListener(evt, blockFlipHandler, true);
        });

        document.getElementById('preloader').style.display = 'none';
      });
    </script>
  </body>

</html>