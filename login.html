<!-- ใส่ firebase-init.js ก่อน -->
<script src="js/firebase-init.js"></script>

<!-- ปุ่ม/แบบฟอร์ม login ของคุณตามเดิม ... -->

<script>
(function(){
  const auth = firebase.auth();

  // ดึง URL เป้าหมายที่จะกลับไปหลังล็อกอิน
  const params = new URLSearchParams(location.search);
  const fallback = new URL('index.html', location.href).href;
  const target = params.get('redirect') || sessionStorage.getItem('redirectAfterLogin') || fallback;

  // เผื่อผู้ใช้มาก่อนหน้าอื่น เก็บ target ชั่วคราว
  sessionStorage.setItem('redirectAfterLogin', target);

  // เมื่อสถานะ “เป็นผู้ใช้” → กลับไป target เลย
  auth.onAuthStateChanged(function(user){
    if (user) {
      const to = sessionStorage.getItem('redirectAfterLogin') || fallback;
      sessionStorage.removeItem('redirectAfterLogin');
      location.replace(to);
    }
  });

  // ===== ตัวอย่างปุ่ม Google =====
  document.getElementById('googleBtn')?.addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    try {
      await auth.signInWithPopup(provider);
      // onAuthStateChanged จะพากลับเอง
    } catch (e) {
      // ถ้าถูกบล็อกป๊อปอัป → fallback เป็น redirect (ยังคง redirect กลับหน้าเดิม)
      if (e && (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user')) {
        await auth.signInWithRedirect(provider);
      } else {
        alert('ล็อกอิน Google ล้มเหลว: ' + (e.code || e.message));
      }
    }
  });

  // ===== ตัวอย่างฟอร์มอีเมล/รหัสผ่าน =====
  document.getElementById('loginForm')?.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const pass  = document.getElementById('login-password').value;
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      // onAuthStateChanged จะพากลับเอง
    }catch(e){
      alert('เข้าสู่ระบบไม่สำเร็จ: ' + (e.code || e.message));
    }
  });

})();
</script>
